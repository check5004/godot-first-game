# Implementation Plan: UI実装

## タスク概要

このタスクリストは、Phase 1で完成したコアゲームプレイシステムに視覚的フィードバック層を追加するUI実装の実装計画です。既存のUIControllerとGame.tscnを段階的に拡張し、6つのUI要素（スコア、コンボ、判定、精度、グレード、デバッグ）の完全な実装を目指します。

## 実装タスク

- [ ] 1. UI要素の表示領域を準備する
- [ ] 1.1 判定表示用のラベルをゲームシーンに配置する
  - 画面中央に判定結果（PERFECT、GOOD、OK、MISS）を表示するラベルを追加
  - フォントサイズを48に設定し、中央揃えで配置
  - 初期状態は非表示に設定
  - _Requirements: 4.1_

- [ ] 1.2 精度とグレード表示用のラベルをゲームシーンに配置する
  - 画面右上に精度パーセンテージを表示するラベルを追加
  - 精度ラベルの下にグレード文字（S/A/B/C/D）を表示するラベルを追加
  - 両方のラベルを中央揃えで配置、初期状態は非表示に設定
  - _Requirements: 5.1, 5.2_

- [ ] 2. 判定表示アニメーションシステムを実装する
- [ ] 2.1 判定結果を受信して表示を更新する機能を実装する
  - 判定シグナルを購読し、判定結果（PERFECT、GOOD、OK、MISS）をラベルに表示
  - 判定結果に応じて色を変更（PERFECT: ゴールド、GOOD: ライムグリーン、OK: オレンジ、MISS: レッド）
  - ラベルを表示状態に切り替え
  - nullセーフティを実装し、ラベルが存在しない場合は処理をスキップ
  - _Requirements: 4.1, 4.2, 4.3, 4.4, 4.5_

- [ ] 2.2 判定表示のフェードアウトアニメーションを実装する
  - Tweenアニメーションを使用して、判定ラベルの透明度を0.5秒かけて1.0から0.0にフェードアウト
  - フェードアウト完了後、判定ラベルを非表示に切り替え
  - 新しい判定が発生した場合、進行中のTweenアニメーションを停止して即座に新しい判定を表示
  - Tweenインスタンスの有効性チェックを実装し、メモリリークを防止
  - _Requirements: 4.6, 4.7, 4.8_

- [ ] 2.3 判定結果の色分けロジックを実装する
  - 判定文字列（PERFECT、GOOD、OK、MISS）をColor値にマッピングするヘルパー機能を実装
  - 不正な判定文字列を受信した場合、デフォルト色（WHITE）を返す防御的処理を追加
  - _Requirements: 4.2, 4.3, 4.4, 4.5_

- [ ] 3. 精度とグレード表示システムを実装する
- [ ] 3.1 精度パーセンテージをリアルタイムで表示する機能を実装する
  - 精度更新シグナルを購読し、精度値を"Accuracy: XX.X%"形式で表示
  - 小数点第1位までの精度でフォーマット
  - 範囲外の精度値（負の値、100.0超過）を0.0~100.0の範囲にクランプ
  - ゲーム開始時は"Accuracy: 0.0%"を表示
  - _Requirements: 5.1, 5.8_

- [ ] 3.2 グレードを計算して色分け表示する機能を実装する
  - 精度更新時にスコア管理システムからグレード（S、A、B、C、D）を取得
  - グレード文字を表示し、グレードに応じて色を変更（S: ゴールド、A: ライムグリーン、B: シアン、C: オレンジ、D: レッド）
  - ゲーム開始時はグレードラベルを非表示に設定、初回精度更新後に表示
  - _Requirements: 5.2, 5.3, 5.4, 5.5, 5.6, 5.7, 5.8_

- [ ] 3.3 グレードの色分けロジックを実装する
  - グレード文字列（S、A、B、C、D）をColor値にマッピングするヘルパー機能を実装
  - 不正なグレード文字列を受信した場合、デフォルト色（WHITE）を返す防御的処理を追加
  - _Requirements: 5.3, 5.4, 5.5, 5.6, 5.7_

- [ ] 4. デバッグ情報表示システムを実装する
- [ ] 4.1 デバッグモードの切り替えに応じて表示を制御する機能を実装する
  - デバッグモード設定値を監視し、有効時のみデバッグ情報を更新
  - デバッグモード無効時は処理を即座にスキップし、パフォーマンス影響を最小化
  - ゲーム開始時、デバッグモード設定値に基づいて表示/非表示を初期化
  - _Requirements: 6.1, 6.2, 6.5, 6.6_

- [ ] 4.2 デバッグ情報をリアルタイムで収集・更新する機能を実装する
  - ゲームコントローラーから現在の音楽再生時刻を取得（小数点第3位まで）
  - エンジンから現在のフレームレート（FPS）を取得
  - オーディオサーバーから出力レイテンシを取得し、ミリ秒単位に変換（小数点第1位まで）
  - ノート生成システムからアクティブなノート数を取得
  - 取得した情報を複数行テキストとしてフォーマットし、デバッグラベルに表示
  - ノード参照が取得できない場合は、"N/A"または"Error"で表示をフォールバック
  - _Requirements: 6.3, 6.4_

- [ ] 4.3 既存のデバッグ表示更新ロジックを移行する
  - ゲームコントローラーに実装されているデバッグ表示更新ロジックを削除
  - デバッグモード切り替え機能はゲームコントローラーに保持（責務の明確化）
  - 移行後、デバッグ表示が正しく動作することを確認
  - _Requirements: 6.1, 6.2, 6.3, 6.4, 6.5_

- [ ] 5. シグナル統合とエラーハンドリングを実装する
- [ ] 5.1 スコア管理システムのシグナルを購読する機能を実装する
  - UI初期化時に、スコア更新、コンボ変更、判定発生、精度更新の4つのシグナルに接続
  - スコア管理システムが存在しない場合、エラーログを出力して処理を継続
  - シグナル接続は1度のみ実行されることを保証
  - _Requirements: 1.1, 1.2_

- [ ] 5.2 UI要素への参照を安全に管理する機能を実装する
  - すべてのUI要素（スコア、コンボ、判定、精度、グレード、デバッグラベル）への参照を保持
  - 各シグナルハンドラ内でnullチェックを実装し、UI要素が存在しない場合は処理をスキップ
  - エラーログを出力せず、静かに失敗する防御的プログラミングを採用
  - _Requirements: 1.3, 1.4_

- [ ] 6. 統合テストを実装する
- [ ] 6.1 判定表示のアニメーションフローをテストする
  - 判定シグナル発火時に判定ラベルが正しく表示され、色が設定されることを検証
  - Tweenアニメーションが0.5秒かけてフェードアウトすることを検証
  - 連続する判定が発生した場合、古いアニメーションが中断され、新しい判定が即座に表示されることを検証
  - フェードアウト完了後、判定ラベルが非表示になることを検証
  - _Requirements: 4.1, 4.2, 4.3, 4.4, 4.5, 4.6, 4.7, 4.8_

- [ ] 6.2 精度とグレード表示の更新フローをテストする
  - 精度更新シグナル発火時に精度ラベルが正しくフォーマットされて表示されることを検証
  - グレード計算が正しく実行され、グレードラベルに表示されることを検証
  - グレードに応じて色が正しく設定されることを検証
  - 範囲外の精度値が正しくクランプされることを検証
  - _Requirements: 5.1, 5.2, 5.3, 5.4, 5.5, 5.6, 5.7, 5.8_

- [ ] 6.3 デバッグ表示の動作をテストする
  - デバッグモード有効時、デバッグ情報が毎フレーム更新されることを検証
  - デバッグモード無効時、デバッグ情報の更新処理がスキップされることを検証
  - ゲームコントローラーやノード参照が取得できない場合、適切にフォールバックすることを検証
  - デバッグ表示更新によるパフォーマンス影響が最小限であることを検証（FPS差1以下）
  - _Requirements: 6.1, 6.2, 6.3, 6.4, 6.5, 6.6_

- [ ] 7. パフォーマンステストとエンドツーエンドテストを実施する
- [ ] 7.1 UI更新のレイテンシとフレームレートを検証する
  - シグナル発火からUI更新完了までの時間が1フレーム以内（16.67ms以下）であることを検証
  - Tweenアニメーション実行中もフレームレートが60 FPSを維持することを検証
  - 1フレーム内に複数のシグナルが発火しても、フレームレートが維持されることを検証
  - _Requirements: 全要件（パフォーマンス目標）_

- [ ] 7.2 実際のゲームプレイシナリオでUI動作を検証する
  - ゲーム開始からノートヒット、コンボ積み上げ、ゲーム終了までのUI表示が正しく動作することを検証
  - コンボブレイク時にコンボラベルが非表示になることを検証
  - 高速連打シナリオ（4レーン同時ノート × 10回連続）で判定表示が正しく切り替わることを検証
  - 長時間プレイ（5分間）でメモリリークが発生しないことを検証（メモリ増加量10MB以下）
  - _Requirements: 全要件（E2Eシナリオ）_

- [ ] 8. コードクリーンアップとドキュメント整備を実施する
- [ ] 8.1 コード品質を向上させる
  - すべての公開メソッドにドキュメントコメント（目的、前提条件、事後条件）を追加
  - 未使用コードや重複コードを削除
  - GDScriptスタイルガイドに準拠していることを確認
  - _Requirements: 全要件（品質保証）_

- [ ] 8.2 実装内容を検証する
  - 6つの要件領域（UIController基盤、スコア、コンボ、判定、精度/グレード、デバッグ）がすべて実装されていることを確認
  - 全Unit/Integration/E2E Testsがパスすることを確認
  - 60 FPS安定動作（デバッグモード有効/無効両方）を確認
  - 既存機能（スコア/コンボ表示）が正常に動作することを確認
  - _Requirements: 全要件_

## 実装順序の注記

- タスク1（UI要素配置）は、タスク2以降の前提条件です。シーンに必要なラベルノードが存在しないと、以降のロジック実装が動作しません。
- タスク2（判定表示）、タスク3（精度/グレード）、タスク4（デバッグ）は、タスク5（シグナル統合）と並行して実装できますが、シグナル接続がないと動作テストができません。
- タスク6（統合テスト）は、タスク2~5の実装完了後に実施します。
- タスク7（パフォーマンステスト、E2Eテスト）は、タスク6の統合テストがパスした後に実施します。
- タスク8（クリーンアップ）は、すべての機能実装とテストが完了した後の最終ステップです。

## 要件カバレッジ

- Requirement 1（UIController基盤システム）: タスク5.1, 5.2
- Requirement 2（スコア表示システム）: 既に実装済み（Phase 1で完了）
- Requirement 3（コンボ表示システム）: 既に実装済み（Phase 1で完了）
- Requirement 4（判定表示アニメーションシステム）: タスク1.1, 2.1, 2.2, 2.3, 6.1
- Requirement 5（精度・グレード表示システム）: タスク1.2, 3.1, 3.2, 3.3, 6.2
- Requirement 6（デバッグ表示システム）: タスク4.1, 4.2, 4.3, 6.3

すべての要件がタスクでカバーされています。
