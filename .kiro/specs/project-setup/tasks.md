# Implementation Plan - Project Setup

**機能名**: project-setup  
**言語**: 日本語  
**生成日**: 2025-09-30  
**基準ドキュメント**: `requirements.md`, `design.md`

---

## タスクリスト

### Phase 1: 基盤構築

- [ ] 1. プロジェクトディレクトリ構造の構築
- [ ] 1.1 必須ディレクトリの作成
  - ゲームシーン格納用ディレクトリを作成
  - UI専用サブディレクトリを作成
  - スクリプト管理用ディレクトリを階層的に作成（AutoLoad、ゲームロジック、UI、エディタ用）
  - アセット管理用ディレクトリをリソース種別ごとに作成（音楽、譜面、テクスチャ、フォント）
  - プラグイン格納用ディレクトリを作成
  - _Requirements: 1.1, 1.2_

- [ ] 1.2 空ディレクトリの保持設定
  - 各ディレクトリに保持用ファイルを配置してバージョン管理対象とする
  - _Requirements: 6.1_

### Phase 2: AutoLoadシステムの実装

- [ ] 2. ゲーム設定管理機能の実装
- [ ] 2.1 タイミング判定システムの定義
  - 判定ウィンドウ時間の定数を定義（PERFECT, GOOD, OK, MISS）
  - 判定種別から対応するウィンドウ時間を取得する機能を実装
  - _Requirements: 2.1_

- [ ] 2.2 スコアリングシステムの定義
  - 各判定に対応するスコア値を定義
  - コンボ数に応じたスコア倍率システムを実装
  - 現在のコンボ数から適用すべき倍率を計算する機能を実装
  - _Requirements: 2.1_

- [ ] 2.3 ノート表示設定の定義
  - ノートの移動速度を定義
  - 判定ライン位置を定義
  - レーン位置の配列を定義
  - _Requirements: 2.1_

- [ ] 2.4 キーマッピングと難易度設定の定義
  - レーンインデックスとキーコードの対応を定義
  - 難易度の列挙型を定義
  - 難易度表示名のマッピングを定義
  - _Requirements: 2.1_

- [ ] 3. スコア管理システムの実装
- [ ] 3.1 状態通知システムの構築
  - スコア更新通知シグナルを定義
  - コンボ変更通知シグナルを定義
  - 判定発生通知シグナルを定義
  - 精度更新通知シグナルを定義
  - _Requirements: 2.2_

- [ ] 3.2 ゲーム状態の管理機能
  - 現在のスコア、コンボ、最大コンボを管理する変数を定義
  - 判定種別ごとのカウント辞書を定義
  - 総ノート数の管理変数を定義
  - _Requirements: 2.2_

- [ ] 3.3 判定処理とスコア計算の実装
  - ゲーム開始時の状態リセット機能を実装
  - 判定追加時のコンボ更新ロジックを実装
  - 基本スコアとコンボ倍率を適用したスコア計算を実装
  - 判定追加時の全シグナル発火を実装
  - _Requirements: 2.2_

- [ ] 3.4 統計計算機能の実装
  - 重み付け精度計算機能を実装（PERFECT=100%, GOOD=70%, OK=40%）
  - 精度に基づくグレード判定機能を実装（S, A, B, C, D）
  - _Requirements: 2.2_

- [ ] 4. 譜面データ管理システムの実装
- [ ] 4.1 ファイル読み込み機能の構築
  - JSONファイル読み込み機能を実装
  - ファイル存在チェックとエラーハンドリングを実装
  - JSON解析とエラー報告機能を実装
  - _Requirements: 2.3_

- [ ] 4.2 データキャッシュ機構の実装
  - 読み込み済み譜面のキャッシュ辞書を実装
  - キャッシュヒット時の再利用ロジックを実装
  - キャッシュ更新機能を実装
  - _Requirements: 2.3_

- [ ] 4.3 譜面データ検証機能の実装
  - メタデータ必須キーの検証を実装（song_title, artist, bpm, offset_sec, song_path）
  - ノートデータ必須キーの検証を実装（beat, lane）
  - レーン番号範囲チェック（0-3）を実装
  - バリデーション失敗時のエラーログ出力を実装
  - _Requirements: 2.3, 6.4_

- [ ] 4.4 譜面保存と一覧取得機能の実装
  - 譜面データのJSON保存機能を実装
  - 利用可能な全譜面ファイルパスの取得機能を実装
  - _Requirements: 2.3_

### Phase 3: プロジェクト設定の構成

- [ ] 5. Godotプロジェクト基本設定の構成
- [ ] 5.1 アプリケーション設定の定義
  - プロジェクト名を設定
  - メインシーンパスを設定
  - 使用機能フラグを設定（Godot 4.5, Forward Plus）
  - _Requirements: 4.1_

- [ ] 5.2 ディスプレイ設定の構成
  - ウィンドウサイズを1280x720に設定
  - ウィンドウモードを設定（ウィンドウ表示、リサイズ可能）
  - ストレッチモードとアスペクト比を設定
  - _Requirements: 4.1_

- [ ] 5.3 AutoLoad登録の実施
  - GameConfig, ScoreManager, ChartLoaderをAutoLoadセクションに登録
  - シングルトンフラグを有効化
  - _Requirements: 4.2, 6.2_

- [ ] 6. Input Mapの設定
- [ ] 6.1 レーン入力アクションの定義
  - lane_0アクション（Dキー）を物理キーコードで登録
  - lane_1アクション（Fキー）を物理キーコードで登録
  - lane_2アクション（Jキー）を物理キーコードで登録
  - lane_3アクション（Kキー）を物理キーコードで登録
  - _Requirements: 3.1, 3.2, 6.3_

- [ ] 6.2 補助アクションの定義
  - toggle_debugアクション（F3キー）を物理キーコードで登録
  - すべてのアクションでエコーを無効化
  - _Requirements: 3.1, 3.2_

- [ ] 7. オーディオバス構成の設定
- [ ] 7.1 オーディオバスレイアウトの作成
  - Masterバスを確認（デフォルト存在）
  - MusicバスをMasterの子として追加
  - SFXバスをMasterの子として追加
  - audio_bus_layout.tresとして保存
  - project.godotのaudio設定にパスを登録
  - _Requirements: 4.1, 4.3_

### Phase 4: テストリソースの準備

- [ ] 8. サンプル譜面データの作成
- [ ] 8.1 譜面JSONファイルの作成
  - メタデータセクションを定義（タイトル、アーティスト、BPM 120、オフセット2秒）
  - 音楽ファイルパスを設定
  - 難易度とメタ情報を設定
  - _Requirements: 5.2_

- [ ] 8.2 ノートパターンの定義
  - 0.5拍刻みの基本パターンを作成（12ノート以上）
  - 全レーン（0-3）を均等に使用
  - 同時押しパターンを1箇所含める
  - _Requirements: 5.2_

- [ ] 9. サンプル音楽ファイルの準備
- [ ] 9.1 音楽ファイルの配置
  - BPM 120のWAV形式音楽ファイルを準備
  - 44.1kHz以上、ステレオまたはモノラルで作成
  - 最低30秒の長さを確保
  - assets/music/ディレクトリに配置
  - _Requirements: 5.1_

- [ ] 10. プレースホルダーテクスチャの作成
- [ ] 10.1 ノート用テクスチャの作成
  - 64x64ピクセル、透明背景の白円画像を作成
  - assets/textures/notes/に配置
  - _Requirements: 5.3_

- [ ] 10.2 背景用テクスチャの作成
  - 1280x720ピクセル、濃い青から黒へのグラデーション画像を作成
  - assets/textures/ui/に配置
  - _Requirements: 5.3_

### Phase 5: セットアップ検証

- [ ] 11. 自動検証スクリプトの作成と実行
- [ ] 11.1 検証スクリプトの実装
  - AutoLoad読み込み確認機能を実装
  - GameConfig定数値の検証機能を実装
  - ScoreManagerリセット機能の検証を実装
  - ChartLoader存在確認を実装
  - _Requirements: 6.2_

- [ ] 11.2 ディレクトリ検証の実装
  - 必須ディレクトリの存在確認機能を実装
  - 検証結果のログ出力を実装
  - _Requirements: 6.1_

- [ ] 11.3 譜面データ検証の実装
  - サンプル譜面の読み込みテストを実装
  - バリデーション機能のテストを実装
  - メタデータとノート数の確認を実装
  - _Requirements: 6.4_

- [ ] 11.4 検証の実行
  - 検証スクリプトをシーンにアタッチして実行
  - Output Logで全項目の成功を確認
  - _Requirements: 6.2, 6.3, 6.4_

- [ ] 12. 手動検証の実施
- [ ] 12.1 エディタ起動確認
  - Godotエディタでプロジェクトをエラーなく開く
  - Output Logで各AutoLoadの初期化メッセージを確認
  - _Requirements: 9_

- [ ] 12.2 設定確認
  - プロジェクト設定のInput Mapタブで全アクションを確認
  - プロジェクト設定のAutoLoadタブで3つのスクリプトを確認
  - Audio Busesパネルで3バス構成を確認
  - _Requirements: 6.3, 6.2, 4.3_

- [ ] 12.3 リソースファイル確認
  - FileSystemパネルでディレクトリ構造を確認
  - サンプル音楽ファイルの再生テストを実施
  - サンプル譜面ファイルの内容を確認
  - _Requirements: 6.1, 5.1, 5.2_

---

## 要件カバレッジマトリクス

| 要件ID | 要件概要 | 対応タスク |
|--------|----------|-----------|
| 1.1 | 必須ディレクトリ定義 | 1.1 |
| 1.2 | ディレクトリの責務 | 1.1 |
| 2.1 | GameConfig.gd実装 | 2.1, 2.2, 2.3, 2.4 |
| 2.2 | ScoreManager.gd実装 | 3.1, 3.2, 3.3, 3.4 |
| 2.3 | ChartLoader.gd実装 | 4.1, 4.2, 4.3, 4.4 |
| 3.1 | 必須アクション定義 | 6.1, 6.2 |
| 3.2 | キー入力設定 | 6.1, 6.2 |
| 4.1 | 基本設定 | 5.1, 5.2, 7.1 |
| 4.2 | AutoLoad登録 | 5.3 |
| 4.3 | オーディオバスレイアウト | 7.1 |
| 5.1 | サンプル音楽ファイル | 9.1 |
| 5.2 | サンプル譜面ファイル | 8.1, 8.2 |
| 5.3 | プレースホルダーテクスチャ | 10.1, 10.2 |
| 6.1 | ディレクトリ検証 | 1.2, 11.2, 12.3 |
| 6.2 | AutoLoadスクリプト検証 | 5.3, 11.1, 12.1, 12.2 |
| 6.3 | Input Map検証 | 6.1, 6.2, 12.2 |
| 6.4 | 譜面データ検証 | 4.3, 11.3 |
| 7.1 | コード品質 | 全タスク（型ヒント使用） |
| 7.2 | ドキュメント | 全AutoLoadタスク |
| 7.3 | エラーハンドリング | 4.1, 4.3 |
| 8.1-8.3 | Windows/PowerShell対応 | 1.1（手動作成推奨） |
| 9 | 成功基準 | 12.1 |

---

## 実装ガイドライン

### コード品質基準
- すべての変数と関数に型ヒント（`: Type`, `-> ReturnType`）を使用
- 定数は`const`、変数は`var`、エクスポート変数は`@export`で明示
- 各スクリプト先頭にファイルパスコメント（`# res://scripts/...`）を記載

### エラーハンドリング
- ファイルI/O失敗時は`push_error()`でログ出力
- バリデーション失敗時は具体的なエラーメッセージを含める
- クリティカルエラー時は安全なデフォルト値（空の辞書`{}`など）を返す

### Windows環境での注意点
- Godot内部パスは常に`res://`プレフィックスと前方スラッシュ`/`を使用
- すべてのファイルをUTF-8（BOMなし）で保存
- PowerShellスクリプトは使用せず、Godotエディタまたは手動でファイル作成

### テスト方針
- 各AutoLoadスクリプトは個別に動作確認可能な設計
- 検証スクリプト（`test_setup.gd`）で自動テスト実施
- 手動チェックリストですべての設定項目を確認

---

**タスク生成完了**  
次のステップ: タスク1から順に実装を開始してください。各タスク完了後、チェックボックスを`[x]`に更新してください。
