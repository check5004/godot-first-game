# 実装タスク：Phase 1 コアゲームプレイ

**バージョン:** 1.0  
**作成日:** 2025年9月30日  
**対象フェーズ:** Phase 1: コアゲームプレイ実装  
**言語:** 日本語

---

## タスク一覧

- [ ] 1. ノートシーンの構築
- [ ] 1.1 Note.tscnシーンの作成
  - Note.tscnファイルを作成し、Area2Dをルートノードとして配置
  - Sprite2Dノードを追加してノートの視覚表現を設定
  - CollisionShape2Dノードを追加して判定領域を定義
  - Note.gdスクリプトをルートノードにアタッチ
  - _Requirements: 2.1.2_

- [ ] 1.2 ノート個体の移動ロジック実装
  - ノートが判定ラインに向かって下方向に移動する機能を実装
  - NOTE_SPEED定数に従って毎フレーム位置を更新
  - レーン番号に応じてノートの色を変更する機能を実装（0=赤, 1=青, 2=緑, 3=黄）
  - _Requirements: 2.1.2, 2.3.3_

- [ ] 1.3 ノートのヒットとMiss処理実装
  - ヒット時にノートを非表示にして削除する機能を実装
  - 判定ライン通過後100px地点でMiss判定を発動する機能を実装
  - Miss判定時にScoreManagerへ通知してノートを削除
  - ノートの`is_hit`フラグで二重処理を防止
  - _Requirements: 2.5.3, 2.1.2_

- [ ] 2. メインゲームシーンの構築
- [ ] 2.1 Game.tscnのノード構成作成
  - Game.tscnファイルを作成し、Node2Dをルートノードとして配置
  - MusicPlayer（AudioStreamPlayer）ノードを追加
  - NoteSpawner、InputHandler、JudgementSystemノードを追加
  - Visuals配下に背景、レーン表示、判定ラインノードを配置
  - UI（CanvasLayer）配下にスコア、コンボ、デバッグ表示用Labelを配置
  - Game.gdスクリプトをルートノードにアタッチ
  - _Requirements: 2.1.1_

- [ ] 2.2 視覚要素の配置
  - 4本のレーンを表示する視覚要素を配置（X座標: 400, 520, 640, 760）
  - 判定ライン（Y座標: 600）を表示する水平線を配置
  - 背景ノードを配置して基本的なゲーム画面を構成
  - _Requirements: 5.2_

- [ ] 3. 高精度時間同期システムの実装
- [ ] 3.1 音楽再生と時刻計算の実装
  - MusicPlayerで音楽ファイルを再生する機能を実装
  - AudioServer APIを使用して補正済み現在時刻を毎フレーム計算
  - get_playback_position、get_time_since_last_mix、get_output_latencyを組み合わせた高精度時刻計算
  - 計算されたprecise_time_secを各サブシステムに配信
  - _Requirements: 2.2.1_

- [ ] 3.2 ゲーム起動シーケンスの実装
  - ChartLoaderから譜面データを読み込む処理を実装
  - ScoreManagerのゲーム状態をリセットする処理を実装
  - 譜面データをNoteSpawnerとJudgementSystemに渡す処理を実装
  - 音楽ファイルをMusicPlayerにセットして0.5秒遅延後に再生開始
  - _Requirements: 2.2.2_

- [ ] 4. ノート生成システムの実装
- [ ] 4.1 譜面データ解析機能の実装
  - 譜面データ（JSON）を受け取ってBPMとオフセットから各ノートの到達時刻を計算
  - beat値をtarget_time_sec（秒）に変換する処理を実装
  - 計算結果を時刻順にソートしてノートキューを準備
  - _Requirements: 2.3.1_

- [ ] 4.2 ノート生成ロジックの実装
  - 現在時刻と比較して生成タイミングに達したノートを検出
  - Note.tscnをインスタンス化してレーン位置と到達時刻を設定
  - 画面外上部（Y: -50）にノートを配置してシーンツリーに追加
  - spawned フラグで重複生成を防止
  - アクティブノート配列でノートを追跡管理
  - _Requirements: 2.3.2_

- [ ] 4.3 レーン別ノート取得機能の実装
  - 指定されたレーン番号に対応するアクティブノートを取得する機能を実装
  - JudgementSystemから呼び出されて判定対象ノートを提供
  - _Requirements: 2.5.2_

- [ ] 5. 入力処理システムの実装
- [ ] 5.1 キー入力検知とレーン変換の実装
  - 4キー（D, F, J, K）の入力を検知する機能を実装
  - GameConfig.KEY_MAPPINGSを使用してキーをレーン番号に変換
  - エコー入力（キー長押し時の連続入力）を無視する処理を実装
  - _Requirements: 2.4.1_

- [ ] 5.2 入力シグナル発行の実装
  - input_receivedシグナルを定義してレーン番号を引数として発行
  - JudgementSystemがシグナルを購読できるように設定
  - _Requirements: 2.4.2_

- [ ] 6. 判定システムの実装
- [ ] 6.1 判定ロジックの実装
  - InputHandlerからの入力シグナルを受信する機能を実装
  - 対象レーンのアクティブノートを取得して最近傍ノートを特定
  - 現在時刻とノート到達時刻の差分を計算
  - 判定ウィンドウ（PERFECT: ±25ms, GOOD: ±50ms, OK: ±80ms）と比較して判定を決定
  - _Requirements: 2.5.1, 2.5.2_

- [ ] 6.2 判定結果の通知処理実装
  - 判定結果をScoreManagerに通知する処理を実装
  - ノートのhit()メソッドを呼び出してノート消滅処理を実行
  - ウィンドウ外の入力は無視（ノート削除なし）
  - 同時押し（複数レーン同時入力）に対応
  - _Requirements: 2.5.2_

- [ ] 7. UI表示システムの実装
- [ ] 7.1 スコア表示の実装
  - ScoreManagerのscore_updatedシグナルを購読
  - 画面上部中央にスコアを表示（フォーマット: "Score: 12345"）
  - シグナル受信時にリアルタイムで表示を更新
  - _Requirements: 5.1_

- [ ] 7.2 コンボ表示の実装
  - ScoreManagerのcombo_changedシグナルを購読
  - 画面中央やや下にコンボを表示（フォーマット: "50 COMBO"）
  - コンボ1以上で表示、コンボ0（Miss時）で非表示
  - _Requirements: 5.1_

- [ ] 7.3 デバッグ表示の実装
  - 画面左上にデバッグ情報を表示（Time, FPS, Latency, Active Notes）
  - F1キーでデバッグ表示のON/OFF切替機能を実装
  - 毎フレーム情報を更新してパフォーマンス監視を可能にする
  - _Requirements: 5.1, 3.2_

- [ ] 8. テストデータの作成
- [ ] 8.1 テスト用譜面ファイルの作成
  - test_song.jsonファイルを作成してメタデータ（BPM, オフセット, 曲パス）を定義
  - 20-50個のノートデータを作成（全4レーンを均等に使用）
  - BPM 100-150の範囲でクリア可能な難易度に設定
  - _Requirements: 4.1_

- [ ] 8.2 テスト用音楽ファイルの準備
  - test_song.wavファイル（30秒程度、WAV形式、44.1kHz以上）を準備
  - 音楽ファイルをassets/music/ディレクトリに配置
  - 譜面データのBPMと音楽ファイルのBPMが一致することを確認
  - _Requirements: 4.1_

- [ ] 9. システム統合とテスト
- [ ] 9.1 コンポーネント統合
  - 全コンポーネントのシグナル接続を確認
  - Game.gdから各サブシステムへのノード参照を設定
  - NoteSpawner、InputHandler、JudgementSystemの連携動作を確認
  - _Requirements: 全要件_

- [ ] 9.2 時間同期精度の検証
  - テスト譜面を再生して音楽とノート移動の同期を確認
  - デバッグ表示でprecise_time_secの精度を監視（目標: ±1ms）
  - レイテンシが20ms以下であることを確認
  - _Requirements: 3.1, 2.2.1_

- [ ] 9.3 判定システムの動作確認
  - メトロノームに合わせた入力でPERFECT判定が出ることを確認
  - 意図的に早押し/遅押しでGOOD/OK判定が出ることを確認
  - ノート通過後の入力が無視されることを確認
  - _Requirements: 7.1, 2.5.2_

- [ ] 9.4 スコアリングの正確性検証
  - PERFECT 10回で1000点になることを確認
  - コンボ10達成後のPERFECT 1回で110点加算されることを確認
  - Miss発生時にコンボが0にリセットされることを確認
  - _Requirements: 7.1, 2.6.1, 2.6.2_

- [ ] 9.5 パフォーマンステスト
  - 60 FPSを安定維持できることを確認
  - 100ノート同時処理でFPS 55以上を維持することを確認
  - メモリリークがないことを確認（曲終了時にActive Notes = 0）
  - _Requirements: 3.1_

- [ ] 9.6 エラーハンドリングの確認
  - 不正な譜面ファイルでエラーメッセージが表示されることを確認
  - 存在しない音楽ファイルでゲーム起動が中断されることを確認
  - デバッグログで各エラー状況が記録されることを確認
  - _Requirements: 3.2_

---

## 実装順序の補足

1. **基礎構築**（タスク1-2）: ノートとゲームシーンの基本構造を構築
2. **時間同期**（タスク3）: 音楽再生と高精度時刻計算を実装
3. **ノート生成**（タスク4）: 譜面データからノートを生成
4. **入力と判定**（タスク5-6）: キー入力を検知して判定処理を実行
5. **UI表示**（タスク7）: スコア、コンボ、デバッグ情報を表示
6. **テストデータ**（タスク8）: 譜面と音楽ファイルを準備
7. **統合とテスト**（タスク9）: 全体を統合してテストを実施

各タスクは前のタスクの成果物を活用するため、順序を守って実装することを推奨します。

---

## 次のステップ

タスクリストを確認し、実装を開始してください。各タスク完了後、このファイルのチェックボックスを更新してください。

全タスク完了後、Phase 1のコアゲームプレイ実装が完了します。
